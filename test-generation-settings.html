<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generation Settings Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .setting-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .setting-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        .setting-value {
            color: #333;
            font-size: 1.1em;
        }
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 12px; 
            border-radius: 4px; 
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 12px; 
            border-radius: 4px; 
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            padding: 12px; 
            border-radius: 4px; 
            margin: 10px 0;
            border-left: 4px solid #17a2b8;
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            padding: 12px; 
            border-radius: 4px; 
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        #results {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-case {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .test-case h3 {
            color: #495057;
            margin-top: 0;
        }
        .lesson-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .highlight-exercise {
            background: #fff3cd;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        .highlight-example {
            background: #d4edda;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }
        .quiz-info {
            background: #e2e3e5;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #6c757d;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧪 AI Generation Settings Test</h1>
        <p>Verify that all customization options are properly implemented in course generation</p>
    </div>

    <div class="test-section">
        <h2>Current Settings</h2>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">Difficulty Level</div>
                <div class="setting-value" id="difficultyLevel">beginner</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Generate Quizzes</div>
                <div class="setting-value" id="generateQuizzes">true</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Quiz Frequency</div>
                <div class="setting-value" id="quizFrequency">module</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Questions per Quiz</div>
                <div class="setting-value" id="questionsPerQuiz">5</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Include Exercises</div>
                <div class="setting-value" id="includeExercises">true</div>
            </div>
            <div class="setting-item">
                <div class="setting-label">Include Examples</div>
                <div class="setting-value" id="includeExamples">true</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Actions</h2>
        <button onclick="testAuthentication()">1. Test Authentication</button>
        <button onclick="getCourses()">2. Get Courses</button>
        <button onclick="getDocuments()">3. Get Documents</button>
        <button onclick="testGenerationWithSettings()">4. Test Generation with Settings</button>
        <button onclick="checkGeneratedContent()">5. Check Generated Content</button>
        <button onclick="runAllTests()">🚀 Run All Tests</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="message"></div>
        <div id="results"></div>
    </div>

    <script>
        let currentJobId = null;
        let currentCourseId = null;
        let testResults = [];

        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = message;
        }

        function addResult(result) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += result + '\n\n';
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testAuthentication() {
            try {
                const response = await fetch('/api/user', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    showMessage(`✅ Authenticated as: ${user.email} (${user.userType})`, 'success');
                    addResult(`Authentication Test: PASSED\nUser: ${JSON.stringify(user, null, 2)}`);
                    return true;
                } else {
                    showMessage('❌ Not authenticated. Please log in first.', 'error');
                    addResult('Authentication Test: FAILED - Not logged in');
                    return false;
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                addResult(`Authentication Test: ERROR - ${error.message}`);
                return false;
            }
        }

        async function getCourses() {
            try {
                const response = await fetch('/api/courses', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const courses = await response.json();
                    if (courses.length > 0) {
                        currentCourseId = courses[0].id;
                        showMessage(`Found ${courses.length} courses. Selected course: ${courses[0].title}`, 'success');
                        addResult(`Courses Found: ${courses.length}\nFirst Course: ${JSON.stringify(courses[0], null, 2)}`);
                        return true;
                    } else {
                        showMessage('No courses found. Create a course first.', 'warning');
                        addResult('Get Courses: No courses available');
                        return false;
                    }
                } else {
                    showMessage('Failed to get courses', 'error');
                    addResult('Get Courses: FAILED');
                    return false;
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                addResult(`Get Courses: ERROR - ${error.message}`);
                return false;
            }
        }

        async function getDocuments() {
            try {
                if (!currentCourseId) {
                    showMessage('Please get courses first', 'warning');
                    return false;
                }

                const response = await fetch(`/api/courses/${currentCourseId}/documents`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const documents = await response.json();
                    if (documents.length > 0) {
                        showMessage(`Found ${documents.length} documents`, 'success');
                        addResult(`Documents Found: ${documents.length}\n${JSON.stringify(documents, null, 2)}`);
                        return documents;
                    } else {
                        showMessage('No documents found. Upload a document first.', 'warning');
                        addResult('Get Documents: No documents available');
                        return false;
                    }
                } else {
                    showMessage('Failed to get documents', 'error');
                    addResult('Get Documents: FAILED');
                    return false;
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                addResult(`Get Documents: ERROR - ${error.message}`);
                return false;
            }
        }

        async function testGenerationWithSettings() {
            try {
                if (!currentCourseId) {
                    showMessage('Please get courses first', 'warning');
                    return false;
                }

                const documents = await getDocuments();
                if (!documents || documents.length === 0) {
                    showMessage('No documents available for generation', 'warning');
                    return false;
                }

                const settings = {
                    difficultyLevel: document.getElementById('difficultyLevel').textContent,
                    generateQuizzes: document.getElementById('generateQuizzes').textContent === 'true',
                    quizFrequency: document.getElementById('quizFrequency').textContent,
                    questionsPerQuiz: parseInt(document.getElementById('questionsPerQuiz').textContent),
                    includeExercises: document.getElementById('includeExercises').textContent === 'true',
                    includeExamples: document.getElementById('includeExamples').textContent === 'true'
                };

                showMessage('Starting AI generation with custom settings...', 'info');
                addResult(`\n=== Testing Generation with Settings ===\n${JSON.stringify(settings, null, 2)}`);

                const response = await fetch('/api/courses/generate-async', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        courseId: currentCourseId,
                        documentIds: [documents[0].id],
                        options: settings
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentJobId = data.jobId;
                    showMessage(`Generation started! Job ID: ${data.jobId}`, 'success');
                    addResult(`Generation Job Started: ${data.jobId}`);
                    
                    // Monitor job progress
                    await monitorJobProgress(data.jobId);
                    return true;
                } else {
                    const error = await response.json();
                    showMessage(`Failed to start generation: ${error.message}`, 'error');
                    addResult(`Generation Start: FAILED - ${error.message}`);
                    return false;
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                addResult(`Generation Test: ERROR - ${error.message}`);
                return false;
            }
        }

        async function monitorJobProgress(jobId) {
            return new Promise((resolve) => {
                const checkInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/api/ai-processing-jobs/${jobId}`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const job = await response.json();
                            showMessage(`Phase: ${job.phase} - Progress: ${job.progress}%`, 'info');
                            
                            if (job.status === 'completed') {
                                clearInterval(checkInterval);
                                showMessage('✅ Generation completed successfully!', 'success');
                                addResult(`Generation Completed: ${JSON.stringify(job, null, 2)}`);
                                resolve(true);
                            } else if (job.status === 'failed') {
                                clearInterval(checkInterval);
                                showMessage(`❌ Generation failed: ${job.error}`, 'error');
                                addResult(`Generation Failed: ${job.error}`);
                                resolve(false);
                            }
                        }
                    } catch (error) {
                        console.error('Error checking job status:', error);
                    }
                }, 2000);
            });
        }

        async function checkGeneratedContent() {
            try {
                if (!currentCourseId) {
                    showMessage('Please run generation test first', 'warning');
                    return false;
                }

                showMessage('Checking generated content for settings compliance...', 'info');
                
                // Get modules and lessons
                const modulesResponse = await fetch(`/api/courses/${currentCourseId}/modules`, {
                    credentials: 'include'
                });
                
                if (!modulesResponse.ok) {
                    showMessage('Failed to get modules', 'error');
                    return false;
                }
                
                const modules = await modulesResponse.json();
                addResult(`\n=== Content Analysis ===\nModules found: ${modules.length}`);
                
                let totalQuizzes = 0;
                let lessonsWithExercises = 0;
                let lessonsWithExamples = 0;
                let totalLessons = 0;
                
                for (const module of modules) {
                    const lessonsResponse = await fetch(`/api/modules/${module.id}/lessons`, {
                        credentials: 'include'
                    });
                    
                    if (lessonsResponse.ok) {
                        const lessons = await lessonsResponse.json();
                        totalLessons += lessons.length;
                        
                        // Check for exercises and examples in lesson content
                        for (const lesson of lessons) {
                            if (lesson.content.includes('Practice Exercise') || 
                                lesson.content.includes('bg-yellow-50')) {
                                lessonsWithExercises++;
                            }
                            if (lesson.content.includes('Real-World Example') || 
                                lesson.content.includes('bg-green-50')) {
                                lessonsWithExamples++;
                            }
                        }
                    }
                    
                    // Check for quizzes
                    const quizzesResponse = await fetch(`/api/modules/${module.id}/quizzes`, {
                        credentials: 'include'
                    });
                    
                    if (quizzesResponse.ok) {
                        const quizzes = await quizzesResponse.json();
                        totalQuizzes += quizzes.length;
                        
                        if (quizzes.length > 0) {
                            addResult(`\nModule: ${module.title}\n  Quizzes: ${quizzes.length}\n  Questions per quiz: ${quizzes[0].questions?.length || 0}`);
                        }
                    }
                }
                
                // Display analysis results
                const settings = {
                    includeExercises: document.getElementById('includeExercises').textContent === 'true',
                    includeExamples: document.getElementById('includeExamples').textContent === 'true',
                    generateQuizzes: document.getElementById('generateQuizzes').textContent === 'true',
                    quizFrequency: document.getElementById('quizFrequency').textContent
                };
                
                addResult(`\n=== Settings Compliance Check ===`);
                addResult(`Total Lessons: ${totalLessons}`);
                addResult(`Total Quizzes: ${totalQuizzes}`);
                addResult(`Lessons with Exercises: ${lessonsWithExercises}/${totalLessons}`);
                addResult(`Lessons with Examples: ${lessonsWithExamples}/${totalLessons}`);
                
                // Validate compliance
                let allTestsPassed = true;
                
                if (settings.generateQuizzes && totalQuizzes === 0) {
                    addResult(`❌ FAILED: Quizzes were requested but none generated`);
                    allTestsPassed = false;
                } else if (!settings.generateQuizzes && totalQuizzes > 0) {
                    addResult(`❌ FAILED: No quizzes requested but ${totalQuizzes} generated`);
                    allTestsPassed = false;
                } else {
                    addResult(`✅ PASSED: Quiz generation setting respected`);
                }
                
                if (settings.includeExercises && lessonsWithExercises === 0) {
                    addResult(`⚠️ WARNING: Exercises requested but none found in content`);
                } else if (settings.includeExercises && lessonsWithExercises > 0) {
                    addResult(`✅ PASSED: Exercises included as requested (${lessonsWithExercises} lessons)`);
                }
                
                if (settings.includeExamples && lessonsWithExamples === 0) {
                    addResult(`⚠️ WARNING: Examples requested but none found in content`);
                } else if (settings.includeExamples && lessonsWithExamples > 0) {
                    addResult(`✅ PASSED: Examples included as requested (${lessonsWithExamples} lessons)`);
                }
                
                if (allTestsPassed) {
                    showMessage('✅ All settings compliance checks passed!', 'success');
                } else {
                    showMessage('⚠️ Some settings may not be fully implemented', 'warning');
                }
                
                return allTestsPassed;
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                addResult(`Content Check: ERROR - ${error.message}`);
                return false;
            }
        }

        async function runAllTests() {
            addResult('\n========== RUNNING COMPREHENSIVE TESTS ==========\n');
            
            // Test 1: Authentication
            const authPassed = await testAuthentication();
            if (!authPassed) {
                showMessage('Please log in to continue tests', 'error');
                return;
            }
            
            // Test 2: Get Courses
            const coursesPassed = await getCourses();
            if (!coursesPassed) {
                showMessage('Please create a course to continue tests', 'warning');
                return;
            }
            
            // Test 3: Get Documents
            const documents = await getDocuments();
            if (!documents) {
                showMessage('Please upload a document to continue tests', 'warning');
                return;
            }
            
            // Test 4: Test Different Settings Combinations
            const testCases = [
                {
                    name: 'Full Features (Exercises + Examples + Quizzes)',
                    settings: {
                        difficultyLevel: 'intermediate',
                        generateQuizzes: true,
                        quizFrequency: 'lesson',
                        questionsPerQuiz: 5,
                        includeExercises: true,
                        includeExamples: true
                    }
                },
                {
                    name: 'No Quizzes (Only Content)',
                    settings: {
                        difficultyLevel: 'beginner',
                        generateQuizzes: false,
                        quizFrequency: 'module',
                        questionsPerQuiz: 5,
                        includeExercises: true,
                        includeExamples: true
                    }
                },
                {
                    name: 'No Exercises or Examples (Minimal)',
                    settings: {
                        difficultyLevel: 'advanced',
                        generateQuizzes: true,
                        quizFrequency: 'module',
                        questionsPerQuiz: 3,
                        includeExercises: false,
                        includeExamples: false
                    }
                }
            ];
            
            showMessage(`Running ${testCases.length} test cases...`, 'info');
            
            for (const testCase of testCases) {
                addResult(`\n=== Test Case: ${testCase.name} ===`);
                
                // Update UI with current settings
                document.getElementById('difficultyLevel').textContent = testCase.settings.difficultyLevel;
                document.getElementById('generateQuizzes').textContent = testCase.settings.generateQuizzes;
                document.getElementById('quizFrequency').textContent = testCase.settings.quizFrequency;
                document.getElementById('questionsPerQuiz').textContent = testCase.settings.questionsPerQuiz;
                document.getElementById('includeExercises').textContent = testCase.settings.includeExercises;
                document.getElementById('includeExamples').textContent = testCase.settings.includeExamples;
                
                // Run generation
                await testGenerationWithSettings();
                
                // Check results
                await checkGeneratedContent();
            }
            
            showMessage('🎉 All tests completed! Check results above.', 'success');
            addResult('\n========== ALL TESTS COMPLETED ==========');
        }
    </script>
</body>
</html>